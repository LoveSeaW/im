import{d as T,e as f,b as j,x as w,c as h,g as c,w as F,f as a,E as g,l as A,a as D,y as x,i as $,u as R,r as V,F as S,h as v,a9 as L,aa as I,ab as U,H}from"./index.00362c69.js";import{b as O}from"./chat_api.69b5704f.js";import{e as P}from"./event_store.c213d25a.js";import{_ as q,a as z,b as G,c as J,d as K,e as Q,f as W}from"./fim_voice.vue_vue_type_style_index_0_lang.f499db3b.js";import{M as X}from"./send_msg.d8fa9662.js";import{_ as Y}from"./fim_event.vue_vue_type_script_setup_true_lang.1e9a9eb5.js";import"./fim_avatar.vue_vue_type_style_index_0_lang.0abc880b.js";import"./date.b8ea58a3.js";import"./file_api.3df89dab.js";const Z={class:"video_action"},ee={key:0,class:"info"},ae={class:"name"},se=a("div",{class:"label"},"\u7B49\u5F85\u63A5\u542C",-1),te={class:"action"},oe={key:0},ie=a("span",{class:"icon"},[a("i",{class:"iconfont icon-shipin"})],-1),ne=a("span",null,"\u6444\u50CF\u5934\u5DF2\u5F00",-1),le=[ie,ne],ce={key:1},ue=a("span",{class:"icon"},[a("i",{class:"iconfont icon-shipin"})],-1),re=a("span",null,"\u9EA6\u514B\u98CE\u5DF2\u5F00",-1),de=[ue,re],_e=a("span",{class:"icon red"},[a("i",{class:"iconfont icon-shipin"})],-1),me=a("span",null,"\u6302\u65AD",-1),fe=[_e,me],ve=T({__name:"fim_video_call",props:{id:{},nickName:{}},setup(B){const s=f(!1),t=f(),d=f(),o=j(),_=f(),m=f(0),y=new X("user"),p=B;function M(){s.value=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then(n=>{t.value.srcObject=n,d.value=n,t.value.muted=!1,y.videoCallMsg(p.id,{flag:0}),u.value=new RTCPeerConnection,u.value.addEventListener("icecandidate",l=>{l.candidate&&y.videoCallMsg(p.id,{flag:9,type:"answer_ice",data:l.candidate})}),u.value.addEventListener("track",l=>{_.value.srcObject=l.streams[0],m.value=1,_.value.muted=!1})}).catch(n=>{g.error("\u65E0\u6743\u9650\u83B7\u53D6\u89C6\u9891\u4FE1\u606F")})}w(()=>o.chatMsgData,()=>{var n,l,e,i,r;if(!!s.value){if(o.chatMsgData.msg.type===12){setTimeout(()=>{s.value=!1},1e3);return}if(o.chatMsgData.msg.type===7){if(((n=o.chatMsgData.msg.videoCallMsg)==null?void 0:n.flag)===6){g.info("\u5BF9\u65B9\u7ED3\u675F\u89C6\u9891\u901A\u8BDD"),s.value=!1,m.value=0,_.value.srcObject=null,t.value.srcObject=null;return}if(((l=o.chatMsgData.msg.videoCallMsg)==null?void 0:l.flag)===4){g.info("\u7528\u6237\u62D2\u7EDD\u4E86\u4F60\u7684\u89C6\u9891\u901A\u8BDD"),s.value=!1,m.value=0,_.value.srcObject=null,t.value.srcObject=null;return}switch((e=o.chatMsgData.msg.videoCallMsg)==null?void 0:e.type){case"create_offer":E();break;case"offer_ice":u.value.addIceCandidate((i=o.chatMsgData.msg.videoCallMsg)==null?void 0:i.data);break;case"answer":C((r=o.chatMsgData.msg.videoCallMsg)==null?void 0:r.data);break}}}},{deep:!0});const u=f();function C(n){u.value.setRemoteDescription(n)}function E(){var n;u.value.addTrack((n=d.value)==null?void 0:n.getVideoTracks()[0],d.value),u.value.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(l=>{u.value.setLocalDescription(l).then(()=>{y.videoCallMsg(p.id,{flag:9,type:"offer",data:l})})})}function N(){u.value.close(),y.videoCallMsg(p.id,{flag:m.value===1?4:1}),s.value=!1,g.info("\u7ED3\u675F\u89C6\u9891\u901A\u8BDD"),m.value=0,_.value.srcObject=null,t.value.srcObject=null}return(n,l)=>{const e=A("el-dialog");return D(),h("div",null,[c(e,{width:"400px","append-to-body":"",modelValue:s.value,"onUpdate:modelValue":l[0]||(l[0]=i=>s.value=i),"modal-class":"video_call_dialog",draggable:""},{default:F(()=>[a("div",Z,[m.value===0?(D(),h("div",ee,[a("div",ae,x(p.nickName),1),se])):$("",!0),a("div",te,[m.value===0?(D(),h("section",oe,le)):$("",!0),m.value===0?(D(),h("section",ce,de)):$("",!0),a("section",{onClick:N},fe)]),a("video",{class:"local_video",ref_key:"localVideo",ref:t,autoplay:"",muted:""},null,512),a("video",{class:"remote_video",ref_key:"remoteVideo",ref:_,autoplay:"",muted:""},null,512)])]),_:1},8,["modelValue"]),a("i",{onClick:M,title:"\u89C6\u9891\u901A\u8BDD",class:"iconfont icon-020-videocallingapp"})])}}});const pe={class:"user_chat_inner_view"},ge={class:"user_chat_inner_head"},he={key:0,class:"more"},De={key:0,class:"user_chat_inner_action"},ye={class:"icon"},be=a("span",null,"\u5220\u9664",-1),Me={class:"icon close_icon"},Ce={class:"user_chat_inner_menu"},ke={class:"user_chat_inner_box"},Te=T({__name:"chat",setup(B){const s=j();P();const t=R();V({content:""});const d=f([]),o=V({friendId:0,limit:10,page:1});async function _(){o.friendId=Number(t.params.id),o.page=1;let e=await O(o);if(e.code){g.error(e.msg);return}const i=e.data.list||[];d.value=[];for(const r of i||[]){const b=p(r);d.value.push(b)}setTimeout(()=>{const r=document.querySelector(".msg_body").clientHeight;M.value.setScrollTop(r)},100)}const m=V({userID:0,nickname:"",abstract:"",avatar:"",notice:"",isOnline:!1});async function y(){let e=await H({friendID:Number(t.params.id)});if(e.code){g.error(e.msg);return}Object.assign(m,e.data)}w(()=>t.params,()=>{y()},{immediate:!0,deep:!0});function p(e){return{id:e.id,user:e.sendUser,isMe:e.isMe,created_at:e.created_at,msg:e.msg,msgPreview:e.msgPreview,showDate:e.showDate}}w(()=>t.params,()=>{_(),s.replayChatMsgData=void 0},{immediate:!0,deep:!0}),w(()=>s.chatMsgData,()=>{var i;if(s.chatMsgData.msg.type===12){g.error((i=s.chatMsgData.msg.tipMsg)==null?void 0:i.content);return}const e=Number(t.params.id);if(s.chatMsgData.revUser.id===e||s.chatMsgData.sendUser.id){if(s.chatMsgData.msg.type===8){_();return}if(s.chatMsgData.id===0)return;d.value.push(p(s.chatMsgData)),setTimeout(()=>{const r=document.querySelector(".msg_body").clientHeight;M.value.setScrollTop(r)},100)}},{deep:!0});const M=f(),u=f(!1),C=f();function E(){var e;(e=C.value)==null||e.close(),u.value=!1}async function N(){var e;await((e=C.value)==null?void 0:e.chatDelete())&&_()}const n=f(!0);async function l(){o.friendId=Number(t.params.id),o.page=o.page+1;let e=await O(o);if(e.code){g.error(e.msg);return}if(d.value.length>=e.data.count){console.log("\u70B9\u5230\u5934\u4E86"),g.info("\u5DF2\u7ECF\u662F\u6700\u65E9\u7684\u6D88\u606F\u4E86"),n.value=!1;return}const i=e.data.list||[],r=[];for(const b of i||[]){const k=p(b);r.push(k)}d.value=[...r,...d.value]}return(e,i)=>{const r=A("el-scrollbar"),b=A("el-icon");return D(),h("div",pe,[a("div",ge,[c(r,{"wrap-class":"chat_body_scrollbar",ref_key:"scrollbarRef",ref:M,height:"100%"},{default:F(()=>[a("div",{class:"msg_body",onMousedown:i[1]||(i[1]=L((...k)=>v(s).showMsgDateMethod&&v(s).showMsgDateMethod(...k),["middle","prevent"]))},[n.value?(D(),h("div",he,[a("span",{onClick:l},"\u52A0\u8F7D\u66F4\u591A")])):$("",!0),c(Q,{ref_key:"fimMsgListRef",ref:C,onCheckShow:i[0]||(i[0]=k=>u.value=!0),"msg-list":d.value,type:"user"},null,8,["msg-list"])],32)]),_:1},512)]),c(Y,{"event-key":"history",onEvent:_}),u.value?(D(),h("div",De,[a("div",ye,[c(b,{onClick:N,size:20},{default:F(()=>[c(v(I))]),_:1}),be]),a("div",Me,[c(b,{onClick:E,size:20},{default:F(()=>[c(v(U))]),_:1})])])):(D(),h(S,{key:1},[a("div",Ce,[c(W),c(q,{id:Number(v(t).params.id),type:"user"},null,8,["id"]),c(z,{id:Number(v(t).params.id),type:"user"},null,8,["id"]),c(G,{id:Number(v(t).params.id),type:"user"},null,8,["id"]),c(J,{id:Number(v(t).params.id),type:"user"},null,8,["id"]),c(ve,{id:Number(v(t).params.id),"nick-name":m.nickname},null,8,["id","nick-name"])]),a("div",ke,[c(K,{id:Number(v(t).params.id),type:"user"},null,8,["id"])])],64))])}}});export{Te as default};
